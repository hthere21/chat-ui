{"version":3,"file":"0-e3a1839e.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/_layout.server.ts.js","../../../.svelte-kit/adapter-node/nodes/0.js"],"sourcesContent":["import { c as collections } from \"../../chunks/database.js\";\nimport { U as UrlDependency } from \"../../chunks/UrlDependency.js\";\nimport { v as validateModel, a as defaultModel, m as models, o as oldModels } from \"../../chunks/models.js\";\nimport { a as authCondition, r as requiresUser } from \"../../chunks/auth.js\";\nimport { D as DEFAULT_SETTINGS } from \"../../chunks/Settings.js\";\nimport { S as SEARXNG_QUERY_URL, E as ENABLE_ASSISTANTS } from \"../../chunks/private.js\";\nimport { ObjectId } from \"mongodb\";\nconst load = async ({ locals, depends }) => {\n  depends(UrlDependency.ConversationList);\n  const settings = await collections.settings.findOne(authCondition(locals));\n  if (settings && !validateModel(models).safeParse(settings?.activeModel).success && !settings.assistants?.map((el) => el.toString())?.includes(settings?.activeModel)) {\n    settings.activeModel = defaultModel.id;\n    await collections.settings.updateOne(authCondition(locals), {\n      $set: { activeModel: defaultModel.id }\n    });\n  }\n  if (settings?.activeModel && models.find((m) => m.id === settings?.activeModel)?.unlisted === true) {\n    settings.activeModel = defaultModel.id;\n    await collections.settings.updateOne(authCondition(locals), {\n      $set: { activeModel: defaultModel.id }\n    });\n  }\n  const enableAssistants = ENABLE_ASSISTANTS === \"true\";\n  const assistantActive = !models.map(({ id }) => id).includes(settings?.activeModel ?? \"\");\n  const assistant = assistantActive ? JSON.parse(\n    JSON.stringify(\n      await collections.assistants.findOne({\n        _id: new ObjectId(settings?.activeModel)\n      })\n    )\n  ) : null;\n  const conversations = await collections.conversations.find(authCondition(locals)).sort({ updatedAt: -1 }).project({\n    title: 1,\n    model: 1,\n    _id: 1,\n    updatedAt: 1,\n    createdAt: 1,\n    assistantId: 1\n  }).limit(300).toArray();\n  const assistantIds = [\n    ...settings?.assistants?.map((assistantId) => assistantId) ?? [],\n    ...conversations.map((conv) => conv.assistantId).filter((el) => !!el)\n  ];\n  const assistants = await collections.assistants.find({ _id: { $in: assistantIds } }).toArray();\n  const messagesBeforeLogin = 0;\n  let loginRequired = false;\n  if (requiresUser && !locals.user && messagesBeforeLogin) {\n    if (conversations.length > messagesBeforeLogin) {\n      loginRequired = true;\n    } else {\n      const totalMessages = (await collections.conversations.aggregate([\n        { $match: { ...authCondition(locals), \"messages.from\": \"assistant\" } },\n        { $project: { messages: 1 } },\n        { $limit: messagesBeforeLogin + 1 },\n        { $unwind: \"$messages\" },\n        { $match: { \"messages.from\": \"assistant\" } },\n        { $count: \"messages\" }\n      ]).toArray())[0]?.messages ?? 0;\n      loginRequired = totalMessages > messagesBeforeLogin;\n    }\n  }\n  return {\n    conversations: conversations.map((conv) => {\n      if (settings?.hideEmojiOnSidebar) {\n        conv.title = conv.title.replace(/\\p{Emoji}/gu, \"\");\n      }\n      conv.title = conv.title.replace(/\\uFFFD/gu, \"\").trimStart();\n      return {\n        id: conv._id.toString(),\n        title: conv.title,\n        model: conv.model ?? defaultModel,\n        updatedAt: conv.updatedAt,\n        assistantId: conv.assistantId?.toString(),\n        avatarHash: conv.assistantId && assistants.find((a) => a._id.toString() === conv.assistantId?.toString())?.avatar\n      };\n    }),\n    settings: {\n      searchEnabled: !!SEARXNG_QUERY_URL,\n      ethicsModalAccepted: !!settings?.ethicsModalAcceptedAt,\n      ethicsModalAcceptedAt: settings?.ethicsModalAcceptedAt ?? null,\n      activeModel: settings?.activeModel ?? DEFAULT_SETTINGS.activeModel,\n      hideEmojiOnSidebar: settings?.hideEmojiOnSidebar ?? false,\n      shareConversationsWithModelAuthors: settings?.shareConversationsWithModelAuthors ?? DEFAULT_SETTINGS.shareConversationsWithModelAuthors,\n      customPrompts: settings?.customPrompts ?? {},\n      assistants: settings?.assistants?.map((el) => el.toString()) ?? []\n    },\n    models: models.map((model) => ({\n      id: model.id,\n      name: model.name,\n      websiteUrl: model.websiteUrl,\n      modelUrl: model.modelUrl,\n      datasetName: model.datasetName,\n      datasetUrl: model.datasetUrl,\n      displayName: model.displayName,\n      description: model.description,\n      logoUrl: model.logoUrl,\n      promptExamples: model.promptExamples,\n      parameters: model.parameters,\n      preprompt: model.preprompt,\n      multimodal: model.multimodal,\n      unlisted: model.unlisted\n    })),\n    oldModels,\n    assistants: assistants.map((el) => ({\n      ...el,\n      _id: el._id.toString(),\n      createdById: void 0,\n      createdByMe: el.createdById.toString() === (locals.user?._id ?? locals.sessionId).toString()\n    })),\n    user: locals.user && {\n      id: locals.user._id.toString(),\n      username: locals.user.username,\n      avatarUrl: locals.user.avatarUrl,\n      email: locals.user.email\n    },\n    assistant,\n    enableAssistants,\n    loginRequired,\n    loginEnabled: requiresUser,\n    guestMode: requiresUser && messagesBeforeLogin > 0\n  };\n};\nexport {\n  load\n};\n","import * as server from '../entries/pages/_layout.server.ts.js';\n\nexport const index = 0;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/_layout.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/+layout.server.ts\";\nexport const imports = [\"_app/immutable/nodes/0.f7a16f12.js\",\"_app/immutable/chunks/scheduler.6a9d17f6.js\",\"_app/immutable/chunks/index.f8ec6462.js\",\"_app/immutable/chunks/navigation.b63c9ed8.js\",\"_app/immutable/chunks/singletons.7e5ab6ef.js\",\"_app/immutable/chunks/stores.7cb53fc7.js\",\"_app/immutable/chunks/public.b85583f5.js\",\"_app/immutable/chunks/titleUpdate.48e3cd22.js\",\"_app/immutable/chunks/cookiesAreEnabled.7d4925e8.js\",\"_app/immutable/chunks/settings.e8a11d43.js\",\"_app/immutable/chunks/close.5676f196.js\",\"_app/immutable/chunks/spread.84d39b6c.js\",\"_app/immutable/chunks/each.81050b20.js\",\"_app/immutable/chunks/checkmark.c1ac77be.js\",\"_app/immutable/chunks/trash-can.c73da904.js\",\"_app/immutable/chunks/index.e2b52378.js\",\"_app/immutable/chunks/Modal.7c732ae4.js\"];\nexport const stylesheets = [\"_app/immutable/assets/0.43b34063.css\"];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}