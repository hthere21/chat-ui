{"version":3,"file":"18-5abcfe22.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/settings/assistants/new/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/18.js"],"sourcesContent":["import { b as base } from \"../../../../../chunks/paths.js\";\nimport { r as requiresUser, a as authCondition, s as sha256 } from \"../../../../../chunks/auth.js\";\nimport { c as collections } from \"../../../../../chunks/database.js\";\nimport { f as fail, r as redirect } from \"../../../../../chunks/index.js\";\nimport { ObjectId } from \"mongodb\";\nimport { z } from \"zod\";\nimport sharp from \"sharp\";\nconst newAsssistantSchema = z.object({\n  name: z.string().min(1),\n  modelId: z.string().min(1),\n  preprompt: z.string().min(1),\n  description: z.string().optional(),\n  exampleInput1: z.string().optional(),\n  exampleInput2: z.string().optional(),\n  exampleInput3: z.string().optional(),\n  exampleInput4: z.string().optional(),\n  avatar: z.instanceof(File).optional()\n});\nconst uploadAvatar = async (avatar, assistantId) => {\n  const hash = await sha256(await avatar.text());\n  const upload = collections.bucket.openUploadStream(`${assistantId.toString()}`, {\n    metadata: { type: avatar.type, hash }\n  });\n  upload.write(await avatar.arrayBuffer());\n  upload.end();\n  return new Promise((resolve, reject) => {\n    upload.once(\"finish\", () => resolve(hash));\n    upload.once(\"error\", reject);\n    setTimeout(() => reject(new Error(\"Upload timed out\")), 1e4);\n  });\n};\nconst actions = {\n  default: async ({ request, locals }) => {\n    const formData = Object.fromEntries(await request.formData());\n    const parse = newAsssistantSchema.safeParse(formData);\n    if (!parse.success) {\n      const errors = parse.error.errors.map((error) => {\n        return {\n          field: error.path[0],\n          message: error.message\n        };\n      });\n      return fail(400, { error: true, errors });\n    }\n    if (!locals.user && requiresUser) {\n      const errors = [{ field: \"preprompt\", message: \"Must be logged in. Unauthorized\" }];\n      return fail(400, { error: true, errors });\n    }\n    const createdById = locals.user?._id ?? locals.sessionId;\n    const newAssistantId = new ObjectId();\n    const exampleInputs = [\n      parse?.data?.exampleInput1 ?? \"\",\n      parse?.data?.exampleInput2 ?? \"\",\n      parse?.data?.exampleInput3 ?? \"\",\n      parse?.data?.exampleInput4 ?? \"\"\n    ].filter((input) => !!input);\n    let hash;\n    if (parse.data.avatar && parse.data.avatar.size > 0) {\n      let image;\n      try {\n        image = await sharp(await parse.data.avatar.arrayBuffer()).resize(512, 512, { fit: \"inside\" }).jpeg({ quality: 80 }).toBuffer();\n      } catch (e) {\n        const errors = [{ field: \"avatar\", message: e.message }];\n        return fail(400, { error: true, errors });\n      }\n      hash = await uploadAvatar(new File([image], \"avatar.jpg\"), newAssistantId);\n    }\n    const { insertedId } = await collections.assistants.insertOne({\n      _id: newAssistantId,\n      createdById,\n      createdByName: locals.user?.username ?? locals.user?.name,\n      ...parse.data,\n      exampleInputs,\n      avatar: hash,\n      createdAt: /* @__PURE__ */ new Date(),\n      updatedAt: /* @__PURE__ */ new Date(),\n      userCount: 1,\n      featured: false\n    });\n    await collections.settings.updateOne(authCondition(locals), {\n      $addToSet: { assistants: insertedId }\n    });\n    throw redirect(302, `${base}/settings/assistants/${insertedId}`);\n  }\n};\nexport {\n  actions\n};\n","import * as server from '../entries/pages/settings/assistants/new/_page.server.ts.js';\n\nexport const index = 18;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/settings/assistants/new/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/settings/assistants/new/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/18.fbbe1aa0.js\",\"_app/immutable/chunks/scheduler.6a9d17f6.js\",\"_app/immutable/chunks/index.f8ec6462.js\",\"_app/immutable/chunks/AssistantSettings.d9badbd8.js\",\"_app/immutable/chunks/preload-helper.a4192956.js\",\"_app/immutable/chunks/each.81050b20.js\",\"_app/immutable/chunks/forms.425d80cf.js\",\"_app/immutable/chunks/parse.bee59afc.js\",\"_app/immutable/chunks/singletons.dcb5d507.js\",\"_app/immutable/chunks/navigation.bcbcd3d3.js\",\"_app/immutable/chunks/pen.34648ac3.js\",\"_app/immutable/chunks/spread.84d39b6c.js\",\"_app/immutable/chunks/IconLoading.fcfe275c.js\",\"_app/immutable/chunks/settings.053bb39b.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}