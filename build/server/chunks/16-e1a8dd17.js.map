{"version":3,"file":"16-e1a8dd17.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/settings/assistants/_assistantId_/_page.ts.js","../../../.svelte-kit/adapter-node/entries/pages/settings/assistants/_assistantId_/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/16.js"],"sourcesContent":["import { b as base } from \"../../../../../chunks/paths.js\";\nimport { r as redirect } from \"../../../../../chunks/index.js\";\nasync function load({ parent, params }) {\n  const data = await parent();\n  const assistant = data.settings.assistants.find((id) => id === params.assistantId);\n  if (!assistant) {\n    throw redirect(302, `${base}/assistant/${params.assistantId}`);\n  }\n  return data;\n}\nexport {\n  load\n};\n","import { c as collections } from \"../../../../../chunks/database.js\";\nimport { f as fail, r as redirect } from \"../../../../../chunks/index.js\";\nimport { ObjectId } from \"mongodb\";\nimport { a as authCondition } from \"../../../../../chunks/auth.js\";\nimport { b as base } from \"../../../../../chunks/paths.js\";\nimport { z } from \"zod\";\nasync function assistantOnlyIfAuthor(locals, assistantId) {\n  const assistant = await collections.assistants.findOne({ _id: new ObjectId(assistantId) });\n  if (!assistant) {\n    throw Error(\"Assistant not found\");\n  }\n  if (assistant.createdById.toString() !== (locals.user?._id ?? locals.sessionId).toString()) {\n    throw Error(\"You are not the author of this assistant\");\n  }\n  return assistant;\n}\nconst actions = {\n  delete: async ({ params, locals }) => {\n    let assistant;\n    try {\n      assistant = await assistantOnlyIfAuthor(locals, params.assistantId);\n    } catch (e) {\n      return fail(400, { error: true, message: e.message });\n    }\n    await collections.assistants.deleteOne({ _id: assistant._id });\n    await collections.settings.updateMany(\n      {\n        assistants: { $in: [assistant._id] }\n      },\n      {\n        $pull: { assistants: assistant._id }\n      }\n    );\n    const fileCursor = collections.bucket.find({ filename: assistant._id.toString() });\n    let fileId = await fileCursor.next();\n    while (fileId) {\n      await collections.bucket.delete(fileId._id);\n      fileId = await fileCursor.next();\n    }\n    throw redirect(302, `${base}/settings`);\n  },\n  report: async ({ request, params, locals, url }) => {\n    const report = await collections.reports.findOne({\n      createdBy: locals.user?._id ?? locals.sessionId,\n      assistantId: new ObjectId(params.assistantId)\n    });\n    if (report) {\n      return fail(400, { error: true, message: \"Already reported\" });\n    }\n    const formData = await request.formData();\n    const result = z.string().min(1).max(128).safeParse(formData?.get(\"reportReason\"));\n    if (!result.success) {\n      return fail(400, { error: true, message: \"Invalid report reason\" });\n    }\n    const { acknowledged } = await collections.reports.insertOne({\n      _id: new ObjectId(),\n      assistantId: new ObjectId(params.assistantId),\n      createdBy: locals.user?._id ?? locals.sessionId,\n      createdAt: /* @__PURE__ */ new Date(),\n      updatedAt: /* @__PURE__ */ new Date(),\n      reason: result.data\n    });\n    if (!acknowledged) {\n      return fail(500, { error: true, message: \"Failed to report assistant\" });\n    }\n    return { from: \"report\", ok: true, message: \"Assistant reported\" };\n  },\n  subscribe: async ({ params, locals }) => {\n    const assistant = await collections.assistants.findOne({\n      _id: new ObjectId(params.assistantId)\n    });\n    if (!assistant) {\n      return fail(404, { error: true, message: \"Assistant not found\" });\n    }\n    const settings = await collections.settings.findOne(authCondition(locals));\n    if (settings?.assistants?.includes(assistant._id)) {\n      return fail(400, { error: true, message: \"Already subscribed\" });\n    }\n    const result = await collections.settings.updateOne(authCondition(locals), {\n      $addToSet: { assistants: assistant._id }\n    });\n    if (result.modifiedCount > 0) {\n      await collections.assistants.updateOne({ _id: assistant._id }, { $inc: { userCount: 1 } });\n    }\n    return { from: \"subscribe\", ok: true, message: \"Assistant added\" };\n  },\n  unsubscribe: async ({ params, locals }) => {\n    const assistant = await collections.assistants.findOne({\n      _id: new ObjectId(params.assistantId)\n    });\n    if (!assistant) {\n      return fail(404, { error: true, message: \"Assistant not found\" });\n    }\n    const result = await collections.settings.updateOne(authCondition(locals), {\n      $pull: { assistants: assistant._id }\n    });\n    if (result.modifiedCount > 0) {\n      await collections.assistants.updateOne({ _id: assistant._id }, { $inc: { userCount: -1 } });\n    }\n    throw redirect(302, `${base}/settings`);\n  }\n};\nexport {\n  actions\n};\n","import * as universal from '../entries/pages/settings/assistants/_assistantId_/_page.ts.js';\nimport * as server from '../entries/pages/settings/assistants/_assistantId_/_page.server.ts.js';\n\nexport const index = 16;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/settings/assistants/_assistantId_/_page.svelte.js')).default;\nexport { universal };\nexport const universal_id = \"src/routes/settings/assistants/[assistantId]/+page.ts\";\nexport { server };\nexport const server_id = \"src/routes/settings/assistants/[assistantId]/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/16.1cec59ba.js\",\"_app/immutable/chunks/singletons.dcb5d507.js\",\"_app/immutable/chunks/scheduler.6a9d17f6.js\",\"_app/immutable/chunks/index.d7eb2526.js\",\"_app/immutable/chunks/control.f5b05b5f.js\",\"_app/immutable/chunks/index.f8ec6462.js\",\"_app/immutable/chunks/forms.425d80cf.js\",\"_app/immutable/chunks/parse.bee59afc.js\",\"_app/immutable/chunks/navigation.bcbcd3d3.js\",\"_app/immutable/chunks/stores.c2158893.js\",\"_app/immutable/chunks/settings.053bb39b.js\",\"_app/immutable/chunks/pen.34648ac3.js\",\"_app/immutable/chunks/spread.84d39b6c.js\",\"_app/immutable/chunks/trash-can.c73da904.js\",\"_app/immutable/chunks/link.7eccf3a0.js\",\"_app/immutable/chunks/CopyToClipBoardBtn.abd1fd98.js\",\"_app/immutable/chunks/Modal.7c732ae4.js\",\"_app/immutable/chunks/index.e2b52378.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}