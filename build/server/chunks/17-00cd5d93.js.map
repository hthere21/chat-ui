{"version":3,"file":"17-00cd5d93.js","sources":["../../../.svelte-kit/adapter-node/entries/pages/settings/assistants/_assistantId_/edit/_page.server.ts.js","../../../.svelte-kit/adapter-node/nodes/17.js"],"sourcesContent":["import { b as base } from \"../../../../../../chunks/paths.js\";\nimport { r as requiresUser, s as sha256 } from \"../../../../../../chunks/auth.js\";\nimport { c as collections } from \"../../../../../../chunks/database.js\";\nimport { f as fail, r as redirect } from \"../../../../../../chunks/index.js\";\nimport { ObjectId } from \"mongodb\";\nimport { z } from \"zod\";\nimport sharp from \"sharp\";\nconst newAsssistantSchema = z.object({\n  name: z.string().min(1),\n  modelId: z.string().min(1),\n  preprompt: z.string().min(1),\n  description: z.string().optional(),\n  exampleInput1: z.string().optional(),\n  exampleInput2: z.string().optional(),\n  exampleInput3: z.string().optional(),\n  exampleInput4: z.string().optional(),\n  avatar: z.union([z.instanceof(File), z.literal(\"null\")]).optional()\n});\nconst uploadAvatar = async (avatar, assistantId) => {\n  const hash = await sha256(await avatar.text());\n  const upload = collections.bucket.openUploadStream(`${assistantId.toString()}`, {\n    metadata: { type: avatar.type, hash }\n  });\n  upload.write(await avatar.arrayBuffer());\n  upload.end();\n  return new Promise((resolve, reject) => {\n    upload.once(\"finish\", () => resolve(hash));\n    upload.once(\"error\", reject);\n    setTimeout(() => reject(new Error(\"Upload timed out\")), 1e4);\n  });\n};\nconst actions = {\n  default: async ({ request, locals, params }) => {\n    const assistant = await collections.assistants.findOne({\n      _id: new ObjectId(params.assistantId)\n    });\n    if (!assistant) {\n      throw Error(\"Assistant not found\");\n    }\n    if (assistant.createdById.toString() !== (locals.user?._id ?? locals.sessionId).toString()) {\n      throw Error(\"You are not the author of this assistant\");\n    }\n    const formData = Object.fromEntries(await request.formData());\n    const parse = newAsssistantSchema.safeParse(formData);\n    if (!parse.success) {\n      const errors = parse.error.errors.map((error) => {\n        return {\n          field: error.path[0],\n          message: error.message\n        };\n      });\n      return fail(400, { error: true, errors });\n    }\n    if (!locals.user && requiresUser) {\n      const errors = [{ field: \"preprompt\", message: \"Must be logged in. Unauthorized\" }];\n      return fail(400, { error: true, errors });\n    }\n    const exampleInputs = [\n      parse?.data?.exampleInput1 ?? \"\",\n      parse?.data?.exampleInput2 ?? \"\",\n      parse?.data?.exampleInput3 ?? \"\",\n      parse?.data?.exampleInput4 ?? \"\"\n    ].filter((input) => !!input);\n    const deleteAvatar = parse.data.avatar === \"null\";\n    let hash;\n    if (parse.data.avatar && parse.data.avatar !== \"null\" && parse.data.avatar.size > 0) {\n      let image;\n      try {\n        image = await sharp(await parse.data.avatar.arrayBuffer()).resize(512, 512, { fit: \"inside\" }).jpeg({ quality: 80 }).toBuffer();\n      } catch (e) {\n        const errors = [{ field: \"avatar\", message: e.message }];\n        return fail(400, { error: true, errors });\n      }\n      const fileCursor = collections.bucket.find({ filename: assistant._id.toString() });\n      let fileId = await fileCursor.next();\n      while (fileId) {\n        await collections.bucket.delete(fileId._id);\n        fileId = await fileCursor.next();\n      }\n      hash = await uploadAvatar(new File([image], \"avatar.jpg\"), assistant._id);\n    } else if (deleteAvatar) {\n      const fileCursor = collections.bucket.find({ filename: assistant._id.toString() });\n      let fileId = await fileCursor.next();\n      while (fileId) {\n        await collections.bucket.delete(fileId._id);\n        fileId = await fileCursor.next();\n      }\n    }\n    const { acknowledged } = await collections.assistants.updateOne(\n      {\n        _id: assistant._id\n      },\n      {\n        $set: {\n          name: parse.data.name,\n          description: parse.data.description,\n          modelId: parse.data.modelId,\n          preprompt: parse.data.preprompt,\n          exampleInputs,\n          avatar: deleteAvatar ? void 0 : hash ?? assistant.avatar,\n          updatedAt: /* @__PURE__ */ new Date()\n        }\n      }\n    );\n    if (acknowledged) {\n      throw redirect(302, `${base}/settings/assistants/${assistant._id}`);\n    } else {\n      throw Error(\"Update failed\");\n    }\n  }\n};\nexport {\n  actions\n};\n","import * as server from '../entries/pages/settings/assistants/_assistantId_/edit/_page.server.ts.js';\n\nexport const index = 17;\nlet component_cache;\nexport const component = async () => component_cache ??= (await import('../entries/pages/settings/assistants/_assistantId_/edit/_page.svelte.js')).default;\nexport { server };\nexport const server_id = \"src/routes/settings/assistants/[assistantId]/edit/+page.server.ts\";\nexport const imports = [\"_app/immutable/nodes/17.c414297f.js\",\"_app/immutable/chunks/scheduler.6a9d17f6.js\",\"_app/immutable/chunks/index.f8ec6462.js\",\"_app/immutable/chunks/stores.7cb53fc7.js\",\"_app/immutable/chunks/singletons.7e5ab6ef.js\",\"_app/immutable/chunks/AssistantSettings.55c2c157.js\",\"_app/immutable/chunks/preload-helper.a4192956.js\",\"_app/immutable/chunks/each.81050b20.js\",\"_app/immutable/chunks/forms.15847325.js\",\"_app/immutable/chunks/parse.bee59afc.js\",\"_app/immutable/chunks/navigation.b63c9ed8.js\",\"_app/immutable/chunks/pen.34648ac3.js\",\"_app/immutable/chunks/spread.84d39b6c.js\",\"_app/immutable/chunks/IconLoading.fcfe275c.js\",\"_app/immutable/chunks/settings.e8a11d43.js\"];\nexport const stylesheets = [];\nexport const fonts = [];\n"],"names":[],"mappings":"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"}