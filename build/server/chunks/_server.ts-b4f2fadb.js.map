{"version":3,"file":"_server.ts-b4f2fadb.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/admin/stats/compute/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../chunks/index.js\";\nimport { c as collections, C as CONVERSATION_STATS_COLLECTION } from \"../../../../../chunks/database.js\";\nasync function POST() {\n  for (const span of [\"day\", \"week\", \"month\"]) {\n    computeStats({ dateField: \"updatedAt\", type: \"conversation\", span }).catch(console.error);\n    computeStats({ dateField: \"createdAt\", type: \"conversation\", span }).catch(console.error);\n    computeStats({ dateField: \"createdAt\", type: \"message\", span }).catch(console.error);\n  }\n  return json({}, { status: 202 });\n}\nasync function computeStats(params) {\n  const lastComputed = await collections.conversationStats.findOne(\n    { \"date.field\": params.dateField, \"date.span\": params.span, type: params.type },\n    { sort: { \"date.at\": -1 } }\n  );\n  const minDate = lastComputed ? lastComputed.date.at : /* @__PURE__ */ new Date(0);\n  console.log(\"Computing stats for\", params.type, params.span, params.dateField, \"from\", minDate);\n  const dateField = params.type === \"message\" ? \"messages.\" + params.dateField : params.dateField;\n  const pipeline = [\n    {\n      $match: {\n        [dateField]: { $gte: minDate }\n      }\n    },\n    {\n      $project: {\n        [dateField]: 1,\n        sessionId: 1,\n        userId: 1\n      }\n    },\n    ...params.type === \"message\" ? [\n      {\n        $unwind: \"$messages\"\n      },\n      {\n        $match: {\n          [dateField]: { $gte: minDate }\n        }\n      }\n    ] : [],\n    {\n      $sort: {\n        [dateField]: 1\n      }\n    },\n    {\n      $facet: {\n        userId: [\n          {\n            $match: {\n              userId: { $exists: true }\n            }\n          },\n          {\n            $group: {\n              _id: {\n                at: { $dateTrunc: { date: `$${dateField}`, unit: params.span } },\n                userId: \"$userId\"\n              }\n            }\n          },\n          {\n            $group: {\n              _id: \"$_id.at\",\n              count: { $sum: 1 }\n            }\n          },\n          {\n            $project: {\n              _id: 0,\n              date: {\n                at: \"$_id\",\n                field: params.dateField,\n                span: params.span\n              },\n              distinct: \"userId\",\n              count: 1\n            }\n          }\n        ],\n        sessionId: [\n          {\n            $match: {\n              sessionId: { $exists: true }\n            }\n          },\n          {\n            $group: {\n              _id: {\n                at: { $dateTrunc: { date: `$${dateField}`, unit: params.span } },\n                sessionId: \"$sessionId\"\n              }\n            }\n          },\n          {\n            $group: {\n              _id: \"$_id.at\",\n              count: { $sum: 1 }\n            }\n          },\n          {\n            $project: {\n              _id: 0,\n              date: {\n                at: \"$_id\",\n                field: params.dateField,\n                span: params.span\n              },\n              distinct: \"sessionId\",\n              count: 1\n            }\n          }\n        ],\n        userOrSessionId: [\n          {\n            $group: {\n              _id: {\n                at: { $dateTrunc: { date: `$${dateField}`, unit: params.span } },\n                userOrSessionId: { $ifNull: [\"$userId\", \"$sessionId\"] }\n              }\n            }\n          },\n          {\n            $group: {\n              _id: \"$_id.at\",\n              count: { $sum: 1 }\n            }\n          },\n          {\n            $project: {\n              _id: 0,\n              date: {\n                at: \"$_id\",\n                field: params.dateField,\n                span: params.span\n              },\n              distinct: \"userOrSessionId\",\n              count: 1\n            }\n          }\n        ],\n        _id: [\n          {\n            $group: {\n              _id: { $dateTrunc: { date: `$${dateField}`, unit: params.span } },\n              count: { $sum: 1 }\n            }\n          },\n          {\n            $project: {\n              _id: 0,\n              date: {\n                at: \"$_id\",\n                field: params.dateField,\n                span: params.span\n              },\n              distinct: \"_id\",\n              count: 1\n            }\n          }\n        ]\n      }\n    },\n    {\n      $project: {\n        stats: {\n          $concatArrays: [\"$userId\", \"$sessionId\", \"$userOrSessionId\", \"$_id\"]\n        }\n      }\n    },\n    {\n      $unwind: \"$stats\"\n    },\n    {\n      $replaceRoot: {\n        newRoot: \"$stats\"\n      }\n    },\n    {\n      $set: {\n        type: params.type\n      }\n    },\n    {\n      $merge: {\n        into: CONVERSATION_STATS_COLLECTION,\n        on: [\"date.at\", \"type\", \"date.span\", \"date.field\", \"distinct\"],\n        whenMatched: \"replace\",\n        whenNotMatched: \"insert\"\n      }\n    }\n  ];\n  await collections.conversations.aggregate(pipeline, { allowDiskUse: true }).next();\n  console.log(\"Computed stats for\", params.type, params.span, params.dateField);\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}