{"version":3,"file":"_server.ts-15641675.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/conversation/_server.ts.js"],"sourcesContent":["import { c as collections } from \"../../../chunks/database.js\";\nimport { ObjectId } from \"mongodb\";\nimport { e as error, r as redirect } from \"../../../chunks/index.js\";\nimport { b as base } from \"../../../chunks/paths.js\";\nimport { z } from \"zod\";\nimport { v as validateModel, m as models, d as defaultEmbeddingModel } from \"../../../chunks/models.js\";\nconst POST = async ({ locals, request }) => {\n  const body = await request.text();\n  let title = \"\";\n  const values = z.object({\n    fromShare: z.string().optional(),\n    model: validateModel(models),\n    assistantId: z.string().optional(),\n    preprompt: z.string().optional()\n  }).parse(JSON.parse(body));\n  let messages = [\n    {\n      id: crypto.randomUUID(),\n      from: \"system\",\n      content: values.preprompt ?? \"\",\n      createdAt: /* @__PURE__ */ new Date(),\n      updatedAt: /* @__PURE__ */ new Date(),\n      children: [],\n      ancestors: []\n    }\n  ];\n  let rootMessageId = messages[0].id;\n  let embeddingModel;\n  if (values.fromShare) {\n    const conversation = await collections.sharedConversations.findOne({\n      _id: values.fromShare\n    });\n    if (!conversation) {\n      throw error(404, \"Conversation not found\");\n    }\n    title = conversation.title;\n    messages = conversation.messages;\n    rootMessageId = conversation.rootMessageId ?? rootMessageId;\n    values.model = conversation.model;\n    values.preprompt = conversation.preprompt;\n    values.assistantId = conversation.assistantId?.toString();\n    embeddingModel = conversation.embeddingModel;\n  }\n  const model = models.find((m) => m.name === values.model);\n  if (!model) {\n    throw error(400, \"Invalid model\");\n  }\n  embeddingModel ??= model.embeddingModel ?? defaultEmbeddingModel.name;\n  if (model.unlisted) {\n    throw error(400, \"Can't start a conversation with an unlisted model\");\n  }\n  const preprompt = await (async () => {\n    if (values.assistantId) {\n      const assistant = await collections.assistants.findOne({\n        _id: new ObjectId(values.assistantId)\n      });\n      return assistant?.preprompt;\n    } else {\n      return values?.preprompt ?? model?.preprompt;\n    }\n  })();\n  const res = await collections.conversations.insertOne({\n    _id: new ObjectId(),\n    title: title || \"New Chat\",\n    rootMessageId,\n    messages,\n    model: values.model,\n    preprompt: preprompt === model?.preprompt ? model?.preprompt : preprompt,\n    assistantId: values.assistantId ? new ObjectId(values.assistantId) : void 0,\n    createdAt: /* @__PURE__ */ new Date(),\n    updatedAt: /* @__PURE__ */ new Date(),\n    embeddingModel,\n    ...locals.user ? { userId: locals.user._id } : { sessionId: locals.sessionId },\n    ...values.fromShare ? { meta: { fromShareId: values.fromShare } } : {}\n  });\n  return new Response(\n    JSON.stringify({\n      conversationId: res.insertedId.toString()\n    }),\n    { headers: { \"Content-Type\": \"application/json\" } }\n  );\n};\nconst GET = async () => {\n  throw redirect(302, `${base}/`);\n};\nexport {\n  GET,\n  POST\n};\n"],"names":[],"mappings":"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"}