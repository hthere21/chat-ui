import{_ as ge}from"../chunks/preload-helper.a4192956.js";import{s as we,m as ye,e as _e,a as Me,o as be,c as Se,f as R,g as Ie,h as N,j as Ee,i as Ae,p as Ce,l as A,N as Te,x as w}from"../chunks/scheduler.6a9d17f6.js";import{S as Ue,i as ke,b as De,c as Oe,a as Pe,m as Le,t as Ne,d as je,e as Je}from"../chunks/index.f8ec6462.js";import{f as te,C as We,c as qe,p as ae,w as Xe,a as Ge}from"../chunks/pendingMessage.54687045.js";import{s as He,i as j,t as oe}from"../chunks/titleUpdate.44e7e95f.js";import{p as Re}from"../chunks/stores.c2158893.js";import{g as K,b as z}from"../chunks/navigation.bcbcd3d3.js";import{b as U}from"../chunks/singletons.dcb5d507.js";import{U as B}from"../chunks/settings.053bb39b.js";import{e as y,E as F}from"../chunks/cookiesAreEnabled.35a078a4.js";function V(e,g,s){var r;if(e.messages.length===0){const m=crypto.randomUUID();return e.rootMessageId=m,e.messages.push({...g,ancestors:[],id:m}),m}if(!s)throw new Error("You need to specify a parentId if this is not the first message");const l=crypto.randomUUID();if(!e.rootMessageId){if(s&&s!==e.messages[e.messages.length-1].id)throw new Error("This is a legacy conversation, you can only append to the last message");return e.messages.push({...g,id:l}),l}const a=[...((r=e.messages.find(m=>m.id===s))==null?void 0:r.ancestors)??[],s];e.messages.push({...g,ancestors:a,id:l,children:[]});const u=e.messages.find(m=>m.id===s);return u&&(u.children?u.children.push(l):u.children=[l]),l}function ne(e,g,s){var m;if(e.messages.length===0)throw new Error("Cannot add a sibling to an empty conversation");if(!e.rootMessageId)throw new Error("Cannot add a sibling to a legacy conversation");const l=e.messages.find(i=>i.id===s);if(!l)throw new Error("The sibling message doesn't exist");if(!l.ancestors||((m=l.ancestors)==null?void 0:m.length)===0)throw new Error("The sibling message is the root message, therefore we can't add a sibling");const a=crypto.randomUUID();e.messages.push({...g,id:a,ancestors:l.ancestors,children:[]});const u=l.ancestors[l.ancestors.length-1],r=e.messages.find(i=>i.id===u);return r&&(r.children?r.children.push(a):r.children=[a]),a}function Ke(e){let g,s,l,a,u,r;document.title=g=e[6];function m(n){e[14](n)}let i={loading:e[3],pending:e[4],messages:e[2],shared:e[0].shared,preprompt:e[0].preprompt,models:e[0].models,currentModel:te([...e[0].models,...e[0].oldModels],e[0].model),assistant:e[0].assistant};return e[5]!==void 0&&(i.files=e[5]),a=new We({props:i}),ye.push(()=>De(a,"files",m)),a.$on("message",e[9]),a.$on("retry",e[10]),a.$on("continue",e[11]),a.$on("vote",e[15]),a.$on("share",e[16]),a.$on("stop",e[17]),{c(){s=_e("link"),l=Me(),Oe(a.$$.fragment),this.h()},l(n){const h=be("svelte-626amo",document.head);s=Se(h,"LINK",{rel:!0,href:!0,integrity:!0,crossorigin:!0}),h.forEach(R),l=Ie(n),Pe(a.$$.fragment,n),this.h()},h(){N(s,"rel","stylesheet"),N(s,"href","https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css"),N(s,"integrity","sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn"),N(s,"crossorigin","anonymous")},m(n,h){Ee(document.head,s),Ae(n,l,h),Le(a,n,h),r=!0},p(n,[h]){(!r||h&64)&&g!==(g=n[6])&&(document.title=g);const o={};h&8&&(o.loading=n[3]),h&16&&(o.pending=n[4]),h&4&&(o.messages=n[2]),h&1&&(o.shared=n[0].shared),h&1&&(o.preprompt=n[0].preprompt),h&1&&(o.models=n[0].models),h&1&&(o.currentModel=te([...n[0].models,...n[0].oldModels],n[0].model)),h&1&&(o.assistant=n[0].assistant),!u&&h&32&&(u=!0,o.files=n[5],Ce(()=>u=!1)),a.$set(o)},i(n){r||(Ne(a.$$.fragment,n),r=!0)},o(n){je(a.$$.fragment,n),r=!1},d(n){n&&R(l),R(s),Je(a,n)}}}function ze(e,g,s){let l,a,u,r,m,i,n,h;A(e,Re,t=>s(1,a=t)),A(e,j,t=>s(7,r=t)),A(e,ae,t=>s(19,m=t)),A(e,y,t=>s(20,i=t)),A(e,oe,t=>s(21,n=t)),A(e,Xe,t=>s(22,h=t));let{data:o}=g,c=o.messages,J=o.messages,M=!1,k=!1,C=[];async function W(){try{s(3,M=!0);const t=await fetch(`${U}/conversation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fromShare:a.params.id,model:o.model})});if(!t.ok){y.set("Error while creating conversation, try again."),console.error("Error while creating conversation: "+await t.text());return}const{conversationId:d}=await t.json();return d}catch(t){throw y.set(F.default),console.error(String(t)),t}}async function E({prompt:t,messageId:d=u.leaf??void 0,isRetry:D=!1,isContinue:O=!1}){var _,Q,Z,v;try{w(j,r=!1,r),s(3,M=!0),s(4,k=!0);const S=await ge(()=>import("../chunks/index.8a46ea8d.js").then(f=>f.i),["../chunks/index.8a46ea8d.js","../chunks/_commonjsHelpers.39b5b250.js"],import.meta.url),X=await Promise.all(C.map(async f=>await S.readAndCompressImage(f,{maxHeight:224,maxWidth:224,quality:1}).then(async b=>await Ge(b))));let P;if(O&&d)(((Q=(_=c.find(f=>f.id===d))==null?void 0:_.children)==null?void 0:Q.length)??0)>0?w(y,i="Can only continue the last message",i):P=d;else if(D&&d){const f=c.find(b=>b.id===d);if(f||w(y,i="Message not found",i),(f==null?void 0:f.from)==="user"&&t){const b=ne({messages:c,rootMessageId:o.rootMessageId},{from:"user",content:t},d);P=V({messages:c,rootMessageId:o.rootMessageId},{from:"assistant",content:"",files:X},b)}else(f==null?void 0:f.from)==="assistant"&&(P=ne({messages:c,rootMessageId:o.rootMessageId},{from:"assistant",content:""},d))}else{const f=V({messages:c,rootMessageId:o.rootMessageId},{from:"user",content:t??"",files:X,createdAt:new Date,updatedAt:new Date},d);o.rootMessageId||s(0,o.rootMessageId=f,o),P=V({messages:c,rootMessageId:o.rootMessageId},{from:"assistant",content:"",createdAt:new Date,updatedAt:new Date},f)}s(2,c=[...c]);const L=c.find(f=>f.id===P);if(!L)throw new Error("Message to write to not found");const he=!!a.data.assistant,T=await fetch(`${U}/conversation/${a.params.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({inputs:t,id:d,is_retry:D,is_continue:O,web_search:!he&&h.useSearch,files:D?void 0:X})});if(s(5,C=[]),!T.body)throw new Error("Body not defined");if(!T.ok){y.set((Z=await T.json())==null?void 0:Z.message);return}const pe=new TextDecoderStream,I=(v=T==null?void 0:T.body)==null?void 0:v.pipeThrough(pe).getReader();let x="";const $=[];let ee=[""];for(;x==="";){if(r||i){I==null||I.cancel();break}await(I==null?void 0:I.read().then(async({done:f,value:b})=>{if(f){I.cancel();return}if(!b)return;b=ee.pop()+b;const G=b.split(`
`);G.forEach(async H=>{try{const p=JSON.parse(H);if(p.type!=="stream"&&$.push(p),p.type==="finalAnswer")x=p.text,I.cancel(),s(3,M=!1),s(4,k=!1),z(B.Conversation);else if(p.type==="stream")s(4,k=!1),L.content+=p.token,s(2,c=[...c]);else if(p.type==="webSearch")L.updates=[...L.updates??[],p],s(2,c=[...c]);else if(p.type==="status")if(p.status==="title"&&p.message){const se=o.conversations.find(({id:ue})=>ue===a.params.id);se&&(se.title=p.message,w(oe,n={title:p.message,convId:a.params.id},n))}else p.status==="error"&&w(y,i=p.message??"An error has occurred",i);else p.type==="error"&&(y.set(p.message),I.cancel())}catch{H===G[G.length-1]&&ee.push(H);return}})}))}L.updates=$,await z(B.ConversationList)}catch(S){S instanceof Error&&S.message.includes("overloaded")?w(y,i="Too much traffic, please try again.",i):S instanceof Error&&S.message.includes("429")?w(y,i=F.rateLimited,i):S instanceof Error?w(y,i=S.message,i):w(y,i=F.default,i),console.error(S)}finally{s(3,M=!1),s(4,k=!1),await z(B.Conversation)}}async function Y(t,d){let D=a.params.id,O;s(2,c=c.map(_=>_.id===d?(O=_.score,{..._,score:t}):_));try{await fetch(`${U}/conversation/${D}/message/${d}/vote`,{method:"POST",body:JSON.stringify({score:t})})}catch{s(2,c=c.map(_=>_.id!==d?_:{..._,score:O}))}}Te(async()=>{m&&(s(5,C=m.files),await E({prompt:m.content}),w(ae,m=void 0,m))});async function re(t){o.shared?await W().then(async d=>{await K(`${U}/conversation/${d}`,{invalidateAll:!0})}).then(async()=>await E({prompt:t.detail})).finally(()=>s(3,M=!1)):await E({prompt:t.detail})}async function ie(t){o.shared?await W().then(async d=>{await K(`${U}/conversation/${d}`,{invalidateAll:!0})}).then(async()=>await E({prompt:t.detail.content,messageId:t.detail.id,isRetry:!0})).finally(()=>s(3,M=!1)):await E({prompt:t.detail.content,messageId:t.detail.id,isRetry:!0})}async function de(t){o.shared?await W().then(async d=>{await K(`${U}/conversation/${d}`,{invalidateAll:!0})}).then(async()=>await E({messageId:t.detail.id,isContinue:!0})).finally(()=>s(3,M=!1)):E({messageId:t.detail.id,isContinue:!0})}const q=qe();A(e,q,t=>s(18,u=t));function le(t){C=t,s(5,C)}const ce=t=>Y(t.detail.score,t.detail.id),fe=()=>He(a.params.id,o.title),me=()=>(w(j,r=!0,r),s(3,M=!1));return e.$$set=t=>{"data"in t&&s(0,o=t.data)},e.$$.update=()=>{var t;e.$$.dirty&8193&&o.messages!==J&&(s(2,c=o.messages),s(13,J=o.messages)),e.$$.dirty&2&&(a.params.id,w(j,r=!0,r),s(3,M=!1),w(q,u.editing=null,u)),e.$$.dirty&3&&s(6,l=((t=o.conversations.find(d=>d.id===a.params.id))==null?void 0:t.title)??o.title)},[o,a,c,M,k,C,l,r,Y,re,ie,de,q,J,le,ce,fe,me]}class ss extends Ue{constructor(g){super(),ke(this,g,ze,Ke,we,{data:0})}}export{ss as component};
